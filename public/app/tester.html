<!DOCTYPE html>
<html lang='en'><head>
<meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>AstraFX — Strategy Tester</title>
<link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
<style>
:root{--bg:#0a0c12;--surface:#0e1420;--border:#1b2232;--text:#d7e0f2;--muted:#a6b0c2;--accent:#4cc38a}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
.topnav{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 20px;border-bottom:1px solid var(--border)}
.btn{background:#12192a;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.primary{background:var(--accent);color:#06120c;border-color:#2f805f}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;margin:16px 20px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.col{display:flex;flex-direction:column;gap:6px}
.chip{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:4px;background:#0f1626;cursor:pointer}
.chip input{margin-right:6px}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
.muted{color:var(--muted)}
</style>
</head>
<body>
  <div class='topnav'>
    <div><strong>Strategy Tester (Last 30 days)</strong></div>
    <div><a class='btn' href='/app/index.html'>Back to Scanner</a></div>
  </div>

  <div class='panel'>
    <div class='row'>
      <div class='col' style='min-width:220px'><label class='muted'>Pairs</label><div id='pairChips' class='row'></div></div>
      <div class='col' style='min-width:220px'><label class='muted'>Timeframes</label><div id='tfChips' class='row'></div></div>
      <div class='col' style='min-width:180px'><label class='muted'>Lookback</label>
        <select id='lookback' class='btn'><option value='30' selected>30 days</option><option value='14'>14 days</option><option value='7'>7 days</option></select>
      </div>
      <div class='col' style='min-width:160px'><label class='muted'>Min Score</label><input id='minScore' type='number' value='70' class='btn' style='width:120px'/></div>
      <div class='col' style='min-width:160px'><label class='muted'>Exit Rule</label><select id='exitRule' class='btn'><option>TP1</option><option>TP2</option><option>TP3</option></select></div>
      <div class='col' style='align-self:flex-end'><button id='runBtn' class='btn primary'>Run Test</button></div>
    </div>
  </div>

  <div class='panel'>
    <div class='row'>
      <div class='col' style='min-width:240px'><label class='muted'>Strategies</label><div id='strategyList'></div></div>
      <div class='col' style='min-width:240px'><label class='muted'>Patterns</label><div id='patternList'></div></div>
      <div class='col' style='min-width:240px'><label class='muted'>Proprietary</label><div id='propList'></div></div>
      <div class='col' style='min-width:260px'><label class='muted'>UDC (Confluences)</label><div id='udcList'></div></div>
    </div>
  </div>

  <div class='panel'>
    <div class='row' style='justify-content:space-between'><strong>Summary</strong><span id='status' class='muted'>Idle</span></div>
    <div id='summary'></div>
  </div>

  <div class='panel'>
    <strong>Per Signal</strong>
    <table id='sigTable'><thead><tr><th>Signal</th><th>Group</th><th>Trades</th><th>Win%</th><th>Wins</th><th>Losses</th><th>Timeouts</th></tr></thead><tbody></tbody></table>
  </div>
  <div class='panel'>
    <strong>Per Pair</strong>
    <table id='pairTable'><thead><tr><th>Pair</th><th>Trades</th><th>Wins</th><th>Losses</th><th>Timeouts</th></tr></thead><tbody></tbody></table>
  </div>

<script>
const PAIRS = ["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","XAUUSD"];
const TFS = ["M15","M30","H1","H4","D1"];
const STRATEGIES = ["donchian20","ema20_50","ichimoku","orb_london","rsi2"];
const PATTERNS = ["pinbar","engulfing","insidebar","nr7","donchian20"];
const PROPS = ["astra1"];
const UDC = ["trend_and_structure","d1_h4_bias","ema20_50_slope","location","htf_sr","supply_demand","fib_overlap","round_levels","prior_day_hilo","classic_pivots","liq_imbalance","liquidity_sweep","fair_value_gap","momentum","pinbar","engulfing","hammer_shooting_star","morning_evening_star","hanging_man"];

function chips(containerId, items){
  const el = document.getElementById(containerId);
  el.innerHTML = items.map(x=>\`<label class='chip'><input type='checkbox' value='\${x}'/>\${x.toUpperCase()}</label>\`).join('');
}
function getSel(containerId){ return Array.from(document.querySelectorAll('#'+containerId+' input:checked')).map(i=>i.value); }

function init(){
  chips('pairChips', PAIRS); chips('tfChips', TFS);
  chips('strategyList', STRATEGIES); chips('patternList', PATTERNS); chips('propList', PROPS);
  document.getElementById('udcList').innerHTML = UDC.map(x=>\`<label class='chip'><input type='checkbox' value='\${x}'/>\${x.replaceAll('_',' ')}</label>\`).join('');
  document.getElementById('runBtn').onclick = runTest;
}

async function runTest(){
  const payload = {
    pairs: getSel('pairChips'),
    timeframes: getSel('tfChips'),
    lookbackDays: parseInt(document.getElementById('lookback').value,10),
    min_score: parseInt(document.getElementById('minScore').value,10),
    filters: {
      strategy: getSel('strategyList'),
      pattern: getSel('patternList'),
      proprietary: getSel('propList'),
      udc: getSel('udcList')
    },
    outcomeBars: 60,
    exitRule: document.getElementById('exitRule').value
  };
  document.getElementById('status').textContent = 'Running…';
  try{
    const res = await fetch('/api/backtest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    document.getElementById('status').textContent = 'Done';
    renderSummary(data);
    renderTables(data);
  }catch(e){
    document.getElementById('status').textContent = 'Error';
    alert('Backtest failed: '+e.message);
  }
}

function renderSummary(d){
  const wr = d.total ? ((d.wins/d.total)*100).toFixed(1) : '0.0';
  document.getElementById('summary').innerHTML = \`
    <div class='row' style='gap:18px'>
      <div>Trades: <strong>\${d.total}</strong></div>
      <div>Wins: <strong>\${d.wins}</strong></div>
      <div>Losses: <strong>\${d.losses}</strong></div>
      <div>Timeouts: <strong>\${d.timeouts}</strong></div>
      <div>Win%: <strong>\${wr}%</strong></div>
      <div>Avg R:R: <strong>\${(d.avg_rr||0).toFixed(2)}</strong></div>
    </div>\`;
}

function renderTables(d){
  const st = document.querySelector('#sigTable tbody');
  const rows = Object.entries(d.per_signal||{}).map(([k,v])=>{
    const wr = v.total ? ((v.wins/v.total)*100).toFixed(1)+'%' : '—';
    return \`<tr><td>\${v.name||k}</td><td>\${v.group}</td><td>\${v.total}</td><td>\${wr}</td><td>\${v.wins}</td><td>\${v.losses}</td><td>\${v.timeouts}</td></tr>\`;
  }).join('');
  st.innerHTML = rows || "<tr><td colspan='7' class='muted'>No signals in the selected period.</td></tr>";

  const pt = document.querySelector('#pairTable tbody');
  const rows2 = Object.entries(d.per_pair||{}).map(([pair,v])=>{
    return \`<tr><td>\${pair}</td><td>\${v.total}</td><td>\${v.wins}</td><td>\${v.losses}</td><td>\${v.timeouts}</td></tr>\`;
  }).join('');
  pt.innerHTML = rows2 || "<tr><td colspan='5' class='muted'>No trades.</td></tr>";
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body></html>
