<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstraFX — Strategy Tester</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0c12;--bg-elev:#0d1119;--surface:#0e1420;--card:#101828;--text:#e7eef7;--sub:#b5c3d6;--muted:#7f8fa3;--border:#1e2a3d;--blue:#1e90ff;--orange:#f97316;--green:#10b981;--red:#ef4444;--radius:18px;--shadow-1:0 10px 30px rgba(0,0,0,.35);--shadow-2:0 20px 60px rgba(0,0,0,.5);--mono:'JetBrains Mono',ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;--sans:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:var(--sans);color:var(--text);background:radial-gradient(1000px 600px at 70% -20%,color-mix(in srgb,var(--orange) 12%,transparent),transparent),radial-gradient(900px 400px at -10% 20%,color-mix(in srgb,var(--blue) 20%,transparent),transparent),linear-gradient(180deg,var(--bg),#07090e)}
    .hero{position:relative;overflow:hidden;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.75)),url('https://images.pexels.com/photos/7054384/pexels-photo-7054384.jpeg?auto=compress&cs=tinysrgb&w=1600') center/cover no-repeat}
    .hero::after{content:'';position:absolute;inset:0;background:radial-gradient(80% 80% at 70% 10%,color-mix(in srgb,var(--blue) 18%,transparent),transparent 70%);mix-blend-mode:screen;opacity:.8;pointer-events:none}
    .topnav{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 20px}
    .brand{display:flex;align-items:center;gap:12px}.logo{width:34px;height:34px;filter:drop-shadow(0 4px 10px rgba(0,0,0,.45))}.brand-name{font-weight:800;letter-spacing:.3px;font-size:1.2rem}.accent{color:var(--blue)}
    .hero-inner{padding:54px 20px 28px;max-width:1200px;margin:0 auto}.hero h1{font-size:clamp(28px,5vw,54px);margin:0 0 10px;line-height:1.05}.hero p{margin:0 0 18px;font-size:clamp(14px,2vw,18px);color:var(--sub)}
    .cta-row{display:flex;gap:14px;flex-wrap:wrap;margin:22px 0}
    .btn{border:1px solid var(--border);background:linear-gradient(180deg,color-mix(in srgb,var(--bg-elev) 60%,transparent),transparent);color:var(--text);padding:14px 18px;border-radius:14px;font-weight:800;letter-spacing:.2px;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease,background .2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-1)}.btn.jumbo{font-size:1.05rem;padding:16px 22px;background:radial-gradient(120% 120% at 20% 0%,color-mix(in srgb,var(--blue) 50%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--blue) 30%,transparent),color-mix(in srgb,var(--orange) 20%,transparent));border:none}
    .btn.jumbo.alt{background:radial-gradient(160% 160% at 20% 0%,color-mix(in srgb,var(--orange) 45%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--orange) 35%,transparent),color-mix(in srgb,var(--blue) 20%,transparent))}
    .subtle{color:var(--muted);font-size:.9rem}

    .bar{display:grid;gap:12px;grid-template-columns:auto auto auto auto 1fr auto;align-items:center;margin:10px 18px}
    .field{display:grid;gap:6px}
    input[type="number"],input[type="text"],select{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text)}
    /* Match UDC select and menu fonts to other dropdowns */
    /*
      The UDC dropdown should mirror the appearance of native <select> controls
      used for the Strategy, Pattern and Proprietary Strategy fields. Instead
      of inheriting automatically, we explicitly set the same font family,
      size, weight and padding as the native selects. This ensures the
      "Select" label and subsequent selections appear identical in style
      and height. Similarly, the checklist entries inside the UDC menu use
      the same font sizing as options in the Strategy dropdown. The width
      remains unchanged to preserve existing layout.
    */
    #udcDisplay{
      font-family:var(--sans);
      font-size:0.9rem;
      line-height:1.2;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      color:var(--text);
      height:auto;
    }
    #udcDisplay span{
      font-family:var(--sans);
      font-size:0.9rem;
      font-weight:400;
    }
    #udcMenu,
    #udcMenu *{
      font-family:var(--sans);
      font-size:0.9rem;
      font-weight:400;
    }
    #udcMenu label{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      white-space:nowrap;
    }
    #udcMenu{
      position:absolute;
      top:100%;
      left:0;
      z-index:1000;
      margin-top:4px;
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      max-height:260px;
      overflow:auto;
      white-space:nowrap;
      width:max-content;
      min-width:100%;
      padding:8px;
      display:none;
    }
    .toggle{display:flex;gap:10px}.opt{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:inherit;font-weight:800;cursor:pointer}
    .opt.active{outline:2px solid color-mix(in srgb,var(--orange) 45%,transparent)}

    .filters{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;margin:0 18px;border-radius:16px;background:linear-gradient(180deg,color-mix(in srgb,var(--surface) 80%,transparent),transparent);border:1px solid var(--border)}
    .chip-group{display:flex;gap:10px;flex-wrap:wrap}.chip{border:1px solid var(--border);background:color-mix(in srgb,var(--card) 70%,transparent);color:inherit;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer}.chip-active{outline:2px solid color-mix(in srgb,var(--blue) 45%,transparent)}

    .watchlist{display:flex;flex-wrap:wrap;gap:8px}
    .wl{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text);font-weight:800}
    .wl.active{outline:2px solid color-mix(in srgb,var(--orange) 45%,transparent)}
    .chip.disabled,.wl.disabled,.opt.disabled{opacity:.45;pointer-events:none}

    .grid{display:grid;gap:18px;padding:18px;margin:0;grid-template-columns:repeat(12,1fr)}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(9,1fr)}}
    @media (max-width:900px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(1,1fr)}}

    .card{grid-column:span 6;border:1px solid var(--border);border-radius:18px;padding:16px;background:radial-gradient(140% 120% at 0% 0%,color-mix(in srgb,var(--blue) 8%,transparent),transparent),radial-gradient(140% 120% at 100% 100%,color-mix(in srgb,var(--orange) 10%,transparent),transparent),var(--card);box-shadow:var(--shadow-1);display:grid;gap:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pair{display:flex;gap:10px;align-items:baseline}.pair .sym{font-weight:800;font-size:1.2rem}.pair .tf{font-weight:700;color:var(--muted)}
    .score{--val:75;--col:var(--blue);width:58px;height:58px;border-radius:50%;background:conic-gradient(var(--col) calc(var(--val)*1%), color-mix(in srgb, var(--col) 15%, #000) 0 100%);display:grid;place-items:center;color:var(--text);font-weight:800;font-size:.95rem;border:2px solid color-mix(in srgb,var(--col) 30%, transparent)}
    .score.good{--col:var(--blue)}.score.ok{--col:#f59e0b}.score.bad{--col:#ef4444}
    .tags{display:flex;gap:8px;flex-wrap:wrap}.tag{font-family:var(--mono);font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px dashed var(--border);color:#c6d2e0;background:rgba(255,255,255,.02)}
    .card-body{display:grid;gap:12px;grid-template-columns: 1fr 1fr;align-items:stretch}
    .levels{display:grid;gap:10px;grid-template-columns:repeat(1,1fr);font-family:var(--mono)}
    .levels .box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px}.levels .label{color:var(--muted);font-size:.78rem}.levels .val{font-weight:800}
    .chart-wrap{border:1px solid var(--border);border-radius:12px;background:var(--surface);position:relative;height:280px}
    .chart{width:100%;height:100%;display:block;border-radius:12px}
    .chart-badge{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.5);color:#fff;font-size:.7rem;border-radius:999px;padding:4px 8px;border:1px solid rgba(255,255,255,.1)}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn.primary{border:none;background:radial-gradient(110% 110% at 20% 0%,color-mix(in srgb,var(--blue) 55%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--blue) 35%,transparent),color-mix(in srgb,var(--orange) 18%,transparent))}
    .btn.alt{border:none;background:radial-gradient(110% 110% at 20% 0%,color-mix(in srgb,var(--orange) 55%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--orange) 35%,transparent),color-mix(in srgb,var(--blue) 18%,transparent))}

    .footer{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;margin:0 18px 18px;color:var(--muted)}

    dialog#copyDlg{border:1px solid var(--border);border-radius:14px;background:var(--card);color:var(--text);width:min(680px,90vw)}
    .copy-body{padding:14px}
    .copy-text{width:100%;min-height:80px;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px;font-family:var(--mono)}
  </style>
</head>

<body>
  <div class="topnav">
    <div class="brand"><h1>Strategy Tester <span class="muted">(Up to the last 30 days)</span></h1></div>
    <div class="nav-actions">
      <button class="btn" onclick="location.href='/app/index.html'">Back to Scanner</button>
    </div>
  </div>

  <div class="hero">
    <div class="controls-row">
      <div class="control"><div class="control-title">Pairs</div><div id="pairChips" class="chips"></div></div>
      <div class="control"><div class="control-title">Timeframes</div><div id="tfChips" class="chips"></div></div>
      <div class="control"><div class="control-title">Lookback</div>
        <select id="lookback" class="select"><option value="30" selected>30 days</option><option value="14">14 days</option><option value="7">7 days</option></select>
      </div>
      <div class="control"><div class="control-title">Min Score</div><input id="minScore" class="input" type="number" value="70"/></div>
      <div class="control"><div class="control-title">Exit Rule</div><select id="exitRule" class="select"><option>TP1</option><option>TP2</option><option>TP3</option></select></div>
      <div class="spacer"></div>
      <button id="runBtn" class="btn primary">Run Test</button>
    </div>
  </div>

  <div class="panel">
    <div class="controls-row">
      <div class="control"><div class="control-title">Strategies</div><div id="strategyList" class="chips"></div></div>
      <div class="control"><div class="control-title">Patterns</div><div id="patternList" class="chips"></div></div>
      <div class="control"><div class="control-title">Proprietary</div><div id="propList" class="chips"></div></div>
      <div class="control"><div class="control-title">UDC (Confluences)</div><div id="udcList" class="chips"></div></div>
    </div>
  </div>

  <div class="panel">
    <div class="controls-row" style="align-items:center;gap:16px">
      <div><strong>Summary</strong></div>
      <div id="status" class="muted">Idle</div>
      <div id="prog" style="height:6px;background:#111;border:1px solid var(--border);border-radius:6px;overflow:hidden;width:220px"><div id="progbar" style="height:100%;width:0%;background:var(--accent)"></div></div>
      <div class="spacer"></div>
      <button id="csvBtn" class="btn">Download CSV</button>
    </div>
    <div id="summary"></div>
  </div>

  <div class="panel">
    <strong>Per Signal</strong>
    <table id="sigTable"><thead><tr><th>Signal</th><th>Group</th><th>Trades</th><th>Win%</th><th>Wins</th><th>Losses</th><th>Timeouts</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="panel">
    <strong>Per Pair</strong>
    <table id="pairTable"><thead><tr><th>Pair</th><th>Trades</th><th>Wins</th><th>Losses</th><th>Timeouts</th></tr></thead><tbody></tbody></table>
  </div>

<script>
const PAIRS = ["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","XAUUSD"];
const TFS = ["M15","M30","H1","H4","D1"];
const STRATEGIES = ["donchian20","ema20_50","ichimoku","orb_london","rsi2"];
const PATTERNS = ["pinbar","engulfing","insidebar","nr7","donchian20"];
const PROPS = ["astra1"];
const UDC = ["trend_and_structure","d1_h4_bias","ema20_50_slope","location","htf_sr","supply_demand","fib_overlap","round_levels","prior_day_hilo","classic_pivots","liq_imbalance","liquidity_sweep","fair_value_gap","momentum","pinbar","engulfing","hammer_shooting_star","morning_evening_star","hanging_man"];

function chip(label, value, checked){ return '<label class="chip"><input type="checkbox" value="'+value+'" '+(checked?'checked':'')+'/>'+label+'</label>'; }
function mkChips(id, items, sel){ const el=document.getElementById(id); el.innerHTML = items.map(x=>chip((x.replaceAll('_',' ').toUpperCase()), x, (sel||[]).includes(x))).join(''); }
function getSelected(id){ return Array.from(document.querySelectorAll('#'+id+' input[type=checkbox]:checked')).map(i=>i.value); }

let __lastResult = null;

function downloadCSV(filename, rows){
  const process = rows.map(r => r.map(v => '"'+String(v).replaceAll('"','""')+'"').join(','));
  const blob = new Blob([process.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function exportCSV(data){
  const rows = [['Signal','Group','Trades','Wins','Losses','Timeouts','Win%']];
  const ps = data.per_signal || {};
  for(const [k,v] of Object.entries(ps)){
    const wr = v.total ? ((v.wins/v.total)*100).toFixed(1) : '0.0';
    rows.push([v.name||k, v.group||'', v.total||0, v.wins||0, v.losses||0, v.timeouts||0, wr]);
  }
  downloadCSV('strategy_tester_per_signal.csv', rows);
}

async function runTest(){
  const status = document.getElementById('status');
  status.textContent = 'Running…';
  const pb = document.getElementById('progbar');
  pb.style.width='10%'; let fake=10; const timer=setInterval(()=>{ fake=Math.min(fake+7,90); pb.style.width=fake+'%'; }, 350);
  const payload = { pairs:getSelected('pairChips'), timeframes:getSelected('tfChips'),
    lookbackDays:parseInt(document.getElementById('lookback').value,10),
    min_score:parseInt(document.getElementById('minScore').value,10),
    filters:{ strategy:getSelected('strategyList'), pattern:getSelected('patternList'), proprietary:getSelected('propList'), udc:getSelected('udcList') },
    outcomeBars:60, exitRule:document.getElementById('exitRule').value };
  if(!payload.pairs.length || !payload.timeframes.length){ clearInterval(timer); pb.style.width='0%'; status.textContent='Idle'; return alert('Please select at least one pair and timeframe.'); }
  try{
    const res = await fetch('/api/backtest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json(); __lastResult = data;
    status.textContent='Done'; clearInterval(timer); pb.style.width='100%'; renderSummary(data); renderTables(data);
  }catch(e){ status.textContent='Error'; clearInterval(timer); alert('Backtest failed: '+e.message); }
}

function renderSummary(d){
  const el = document.getElementById('summary');
  const wr = d.total ? ((d.wins/d.total)*100).toFixed(1) : '0.0';
  el.innerHTML = '<div class="controls-row" style="gap:20px">'
    + '<div>Trades: <strong>'+d.total+'</strong></div>'
    + '<div>Wins: <strong>'+d.wins+'</strong></div>'
    + '<div>Losses: <strong>'+d.losses+'</strong></div>'
    + '<div>Timeouts: <strong>'+d.timeouts+'</strong></div>'
    + '<div>Win%: <strong>'+wr+'%</strong></div>'
    + '<div>Avg R:R: <strong>'+((d.avg_rr||0).toFixed?d.avg_rr.toFixed(2):d.avg_rr)+'</strong></div>'
    + '</div>';
}
function renderTables(d){
  const st = document.querySelector('#sigTable tbody');
  const rows = Object.entries(d.per_signal||{}).map(([k,v])=>{
    const wr = v.total ? ((v.wins/v.total)*100).toFixed(1)+'%' : '—';
    return '<tr><td>'+(v.name||k)+'</td><td>'+v.group+'</td><td>'+v.total+'</td><td>'+wr+'</td><td>'+v.wins+'</td><td>'+v.losses+'</td><td>'+v.timeouts+'</td></tr>';
  }).join('');
  st.innerHTML = rows || '<tr><td colspan="7" class="muted">No signals in the selected period.</td></tr>';
  const pt = document.querySelector('#pairTable tbody');
  const rows2 = Object.entries(d.per_pair||{}).map(([pair,v])=>{
    return '<tr><td>'+pair+'</td><td>'+v.total+'</td><td>'+v.wins+'</td><td>'+v.losses+'</td><td>'+v.timeouts+'</td></tr>';
  }).join('');
  pt.innerHTML = rows2 || '<tr><td colspan="5" class="muted">No trades.</td></tr>';
}

document.addEventListener('DOMContentLoaded', ()=>{
  mkChips('pairChips', PAIRS, ['EURUSD','XAUUSD']);
  mkChips('tfChips', TFS, ['H1','M15']);
  mkChips('strategyList', STRATEGIES, []);
  mkChips('patternList', PATTERNS, []);
  mkChips('propList', PROPS, ['astra1']);
  mkChips('udcList', UDC, []);
  const csv=document.getElementById('csvBtn'); if(csv){ csv.onclick=()=>{ if(__lastResult) exportCSV(__lastResult); else alert('Run a test first.'); }; }
  const run=document.getElementById('runBtn'); if(run){ run.onclick=runTest; }
});
</script>
</body>

</html>