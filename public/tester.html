<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstraFX â€” Frontend v1.3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0c12;--bg-elev:#0d1119;--surface:#0e1420;--card:#101828;--text:#e7eef7;--sub:#b5c3d6;--muted:#7f8fa3;--border:#1e2a3d;--blue:#1e90ff;--orange:#f97316;--green:#10b981;--red:#ef4444;--radius:18px;--shadow-1:0 10px 30px rgba(0,0,0,.35);--shadow-2:0 20px 60px rgba(0,0,0,.5);--mono:'JetBrains Mono',ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;--sans:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:var(--sans);color:var(--text);background:radial-gradient(1000px 600px at 70% -20%,color-mix(in srgb,var(--orange) 12%,transparent),transparent),radial-gradient(900px 400px at -10% 20%,color-mix(in srgb,var(--blue) 20%,transparent),transparent),linear-gradient(180deg,var(--bg),#07090e)}
    .hero{position:relative;overflow:hidden;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.75)),url('https://images.pexels.com/photos/7054384/pexels-photo-7054384.jpeg?auto=compress&cs=tinysrgb&w=1600') center/cover no-repeat}
    .hero::after{content:'';position:absolute;inset:0;background:radial-gradient(80% 80% at 70% 10%,color-mix(in srgb,var(--blue) 18%,transparent),transparent 70%);mix-blend-mode:screen;opacity:.8;pointer-events:none}
    .topnav{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 20px}
    .brand{display:flex;align-items:center;gap:12px}.logo{width:34px;height:34px;filter:drop-shadow(0 4px 10px rgba(0,0,0,.45))}.brand-name{font-weight:800;letter-spacing:.3px;font-size:1.2rem}.accent{color:var(--blue)}
    .hero-inner{padding:54px 20px 28px;max-width:1200px;margin:0 auto}.hero h1{font-size:clamp(28px,5vw,54px);margin:0 0 10px;line-height:1.05}.hero p{margin:0 0 18px;font-size:clamp(14px,2vw,18px);color:var(--sub)}
    .cta-row{display:flex;gap:14px;flex-wrap:wrap;margin:22px 0}
    .btn{border:1px solid var(--border);background:linear-gradient(180deg,color-mix(in srgb,var(--bg-elev) 60%,transparent),transparent);color:var(--text);padding:14px 18px;border-radius:14px;font-weight:800;letter-spacing:.2px;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease,background .2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-1)}.btn.jumbo{font-size:1.05rem;padding:16px 22px;background:radial-gradient(120% 120% at 20% 0%,color-mix(in srgb,var(--blue) 50%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--blue) 30%,transparent),color-mix(in srgb,var(--orange) 20%,transparent));border:none}
    .btn.jumbo.alt{background:radial-gradient(160% 160% at 20% 0%,color-mix(in srgb,var(--orange) 45%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--orange) 35%,transparent),color-mix(in srgb,var(--blue) 20%,transparent))}
    .subtle{color:var(--muted);font-size:.9rem}

 
    .toggle{display:flex;gap:10px}.opt{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:inherit;font-weight:800;cursor:pointer}
    .opt.active{outline:2px solid color-mix(in srgb,var(--orange) 45%,transparent)}

    .filters{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;margin:0 18px;border-radius:16px;background:linear-gradient(180deg,color-mix(in srgb,var(--surface) 80%,transparent),transparent);border:1px solid var(--border)}
    .chip-group{display:flex;gap:10px;flex-wrap:wrap}.chip{border:1px solid var(--border);background:color-mix(in srgb,var(--card) 70%,transparent);color:inherit;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer}.chip-active{outline:2px solid color-mix(in srgb,var(--blue) 45%,transparent)}

    .watchlist{display:flex;flex-wrap:wrap;gap:8px}
    .wl{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text);font-weight:800}
    .wl.active{outline:2px solid color-mix(in srgb,var(--orange) 45%,transparent)}
    .chip.disabled,.wl.disabled,.opt.disabled{opacity:.45;pointer-events:none}

    .grid{display:grid;gap:18px;padding:18px;margin:0;grid-template-columns:repeat(12,1fr)}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(9,1fr)}}
    @media (max-width:900px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(1,1fr)}}

    .card{grid-column:span 6;border:1px solid var(--border);border-radius:18px;padding:16px;background:radial-gradient(140% 120% at 0% 0%,color-mix(in srgb,var(--blue) 8%,transparent),transparent),radial-gradient(140% 120% at 100% 100%,color-mix(in srgb,var(--orange) 10%,transparent),transparent),var(--card);box-shadow:var(--shadow-1);display:grid;gap:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pair{display:flex;gap:10px;align-items:baseline}.pair .sym{font-weight:800;font-size:1.2rem}.pair .tf{font-weight:700;color:var(--muted)}
    .score{--val:75;--col:var(--blue);width:58px;height:58px;border-radius:50%;background:conic-gradient(var(--col) calc(var(--val)*1%), color-mix(in srgb, var(--col) 15%, #000) 0 100%);display:grid;place-items:center;color:var(--text);font-weight:800;font-size:.95rem;border:2px solid color-mix(in srgb,var(--col) 30%, transparent)}
    .score.good{--col:var(--blue)}.score.ok{--col:#f59e0b}.score.bad{--col:#ef4444}
    .tags{display:flex;gap:8px;flex-wrap:wrap}.tag{font-family:var(--mono);font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px dashed var(--border);color:#c6d2e0;background:rgba(255,255,255,.02)}
    .card-body{display:grid;gap:12px;grid-template-columns: 1fr 1fr;align-items:stretch}
    .levels{display:grid;gap:10px;grid-template-columns:repeat(1,1fr);font-family:var(--mono)}
    .levels .box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px}.levels .label{color:var(--muted);font-size:.78rem}.levels .val{font-weight:800}
    .chart-wrap{border:1px solid var(--border);border-radius:12px;background:var(--surface);position:relative;height:280px}
    .chart{width:100%;height:100%;display:block;border-radius:12px}
    .chart-badge{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.5);color:#fff;font-size:.7rem;border-radius:999px;padding:4px 8px;border:1px solid rgba(255,255,255,.1)}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn.primary{border:none;background:radial-gradient(110% 110% at 20% 0%,color-mix(in srgb,var(--blue) 55%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--blue) 35%,transparent),color-mix(in srgb,var(--orange) 18%,transparent))}
    .btn.alt{border:none;background:radial-gradient(110% 110% at 20% 0%,color-mix(in srgb,var(--orange) 55%,transparent),transparent),linear-gradient(180deg,color-mix(in srgb,var(--orange) 35%,transparent),color-mix(in srgb,var(--blue) 18%,transparent))}

    .footer{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;margin:0 18px 18px;color:var(--muted)}

    dialog#copyDlg{border:1px solid var(--border);border-radius:14px;background:var(--card);color:var(--text);width:min(680px,90vw)}
    .copy-body{padding:14px}
    .copy-text{width:100%;min-height:80px;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px;font-family:var(--mono)}
  </style>
</head>
<body>
  <header class="hero">
    <nav class="topnav">
      <div class="brand">
        <svg class="logo" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" rx="10" fill="#0a0c12"/>
          <rect x="10" y="22" width="8" height="28" rx="2" fill="#1e90ff"/>
          <rect x="22" y="16" width="8" height="34" rx="2" fill="#0ea5e9"/>
          <rect x="34" y="24" width="8" height="26" rx="2" fill="#f97316"/>
          <rect x="46" y="18" width="8" height="32" rx="2" fill="#1e90ff"/>
        </svg>
        <span class="brand-name">Astra<span class="accent">FX</span></span>
      </div>
      <div class="nav-actions">
        <button class="btn" id="openSettings">Contract Settings</button>
        <button class="btn" id="openJournal">Trade Journal</button>
        <a class="btn" href="/tester.html">Strategy Tester</a>
      </div>
    </nav>
    <div class="hero-inner">
      <h1>Daily <span class="accent">High-Probability</span> FX Setups</h1>
      <p>Live chart scans on demand, Clean Entry, SL/TP, and pip value based on your desired risk.</p>
      <div class="cta-row">
        <button class="btn jumbo" id="analyzeBtn">âš¡ Analyze Now</button>
        <button class="btn jumbo alt" id="saveAllBtn">ðŸ’¾ Save All Charts</button>
        <span class="subtle" id="status" aria-live="polite"></span>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:-60px; padding-bottom:60px">
    <!-- Controls grid -->
    <div class="panel">
      <div class="grid">
        <div>
          <div class="muted">Pairs</div>
          <select id="pair">
            <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>AUDUSD</option>
            <option>USDCAD</option><option>USDCHF</option><option>NZDUSD</option>
            <option>XAUUSD</option><option>EURJPY</option><option>GBPJPY</option><option>AUDJPY</option><option>CADJPY</option>
            <option>EURGBP</option><option>EURAUD</option>
          </select>
        </div>
        <div>
          <div class="muted">Timeframe</div>
          <select id="tf">
            <option>M5</option><option selected>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option>
          </select>
        </div>
        <div>
          <div class="muted">Lookback</div>
          <select id="look">
            <option>3 days</option><option>7 days</option><option>14 days</option><option selected>30 days</option>
          </select>
        </div>
        <div>
          <div class="muted">Min Score</div>
          <div class="rangeWrap">
            <input id="score" type="range" min="0" max="100" value="70" oninput="document.getElementById('sout').value=this.value">
            <output id="sout">70</output>
          </div>
        </div>
        <div>
          <div class="muted">Exit Rule</div>
          <select id="exit"><option>TP1</option><option selected>TP2</option><option>TP3</option></select>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <div class="muted">Strategy</div>
          <select id="strategy">
            <option value="">â€” Select â€”</option>
            <option value="ichimoku">Ichimoku</option>
            <option value="ema_pullback">EMA(9/21) Pullback</option>
            <option value="bbsqueeze">Bollinger Squeeze Breakout</option>
            <option value="donchian">Donchian 20 Break</option>
            <option value="orb_london">Opening-Range Breakout (London)</option>
            <option value="rsi2">RSI-2 Mean Reversion</option>
          </select>
        </div>
        <div>
          <div class="muted">Pattern</div>
          <select id="pattern">
            <option value="">â€” Select â€”</option>
            <option value="pinbar">Pin Bar</option>
            <option value="engulfing">Engulfing</option>
            <option value="insidebar">Inside Bar</option>
            <option value="nr7">NR7</option>
          </select>
        </div>
        <div>
          <div class="muted">AstraFX Proprietary Strategies</div>
          <select id="prop">
            <option value="">â€” Select â€”</option>
            <option value="astra1">AstraFX #1</option>
          </select>
        </div>
        <div style="grid-column: span 3">
          <div class="muted">User Defined Confluence</div>
          <select id="udc" class="multi" multiple>
          </select>
          <div class="muted-note">Tip: Hold Ctrl/Cmd to select multiple confluences. Selecting here will disable the other pickers.</div>
        </div>
      </div>

      <div class="status"><strong>Summary:</strong> <span id="sum" class="muted">Idle</span>
        <div class="bar"><span id="bar"></span></div>
      </div>
    </div>

    <div style="display:flex; align-items:flex-start; gap:16px; margin-top:18px">
      <div style="flex:1">
        <div class="section-title">RESULTS</div>
        <div id="resultsBox" class="results">â€”</div>
      </div>
      <div class="actions">
        <button class="btn primary" id="runBtn">Run Test</button>
        <button class="btn" id="csvBtn" disabled>Download CSV</button>
      </div>
    </div>
  </main>

  <script>
    // Populate UDC items from known server list
    const UDC_ITEMS = [
      "Trend and structure","D1/H4 bias","20/50 EMA slope/stack","Location","HTF S/R",
      "Supply - Demand zones","FIB overlap","Round levels","Prior day high or low","Classic pivots",
      "Liquidity & Imbalance","Liquidity sweep","Fair Value Gap","Momentum Confirmation",
      "Pinbar","Engulfing","Hammer / Shooting star","Morning star / Evening star","Hanging man"
    ];

    const udcEl = document.getElementById('udc');
    for(const it of UDC_ITEMS){ const o=document.createElement('option'); o.textContent=it; o.value=it; udcEl.appendChild(o); }

    // Mutually exclusive second row
    const ids = ['strategy','pattern','prop','udc'];
    function enforceExclusivity(source){
      const hasStrategy = document.getElementById('strategy').value !== "";
      const hasPattern  = document.getElementById('pattern').value  !== "";
      const hasProp     = document.getElementById('prop').value     !== "";
      const hasUdc      = document.getElementById('udc').selectedOptions.length > 0;
      const on = {strategy:hasStrategy, pattern:hasPattern, prop:hasProp, udc:hasUdc};
      for(const id of ids){
        const el = document.getElementById(id);
        const active = on[id];
        if(active){
          for(const other of ids){ if(other!==id){ const o=document.getElementById(other); o.disabled=true; o.classList.add('muted'); } }
        }else{
          if(!Object.values(on).some(v=>v)){ // none selected
            el.disabled=false; el.classList.remove('muted');
          }
        }
      }
    }
    for(const id of ids){
      const el=document.getElementById(id);
      el.addEventListener('change', ()=>enforceExclusivity(id));
    }

    // Build query & run
    const runBtn=document.getElementById('runBtn');
    const csvBtn=document.getElementById('csvBtn');
    const bar=document.getElementById('bar');
    const sum=document.getElementById('sum');
    const res=document.getElementById('resultsBox');
    let lastTrades=[];

    function lookVal(){ return parseInt(document.getElementById('look').value); }
    // normalize lookback value (label -> int)
    (function normalizeLookback(){
      const el=document.getElementById('look');
      const v=el.value; const n=parseInt(v);
      el.addEventListener('change', ()=>{});
      el.value="30 days"; // visual default
      Object.defineProperty(window,'lookBackDays',{get(){ return parseInt(document.getElementById('look').value); }});
    })();

    document.getElementById('look').addEventListener('change', (e)=>{
      // nothing needed; just a select
    });

    function getLookback(){
      const txt = document.getElementById('look').value;
      return parseInt(txt);
    }

    runBtn.addEventListener('click', async ()=>{
      // progress start
      bar.style.width='20%'; sum.textContent='Runningâ€¦';
      const pair=document.getElementById('pair').value;
      const tf=document.getElementById('tf').value;
      const lb=getLookback();
      const score=document.getElementById('score').value;
      const exit=document.getElementById('exit').value;
      // group
      let group=''; let signal=''; let udc=[];
      if(document.getElementById('strategy').value){ group='strategy'; signal=document.getElementById('strategy').value; }
      else if(document.getElementById('pattern').value){ group='pattern'; signal=document.getElementById('pattern').value; }
      else if(document.getElementById('prop').value){ group='prop'; signal=document.getElementById('prop').value; }
      else { group='udc'; udc=[...document.getElementById('udc').selectedOptions].map(o=>o.value); }
      bar.style.width='35%';
      const params=new URLSearchParams({pair, tf, lookback_days:String(lb), min_score:String(score), exit_rule:exit, group, signal:signal||'', udc:udc.join(',')});
      const r=await fetch('/api/tester?'+params.toString());
      bar.style.width='60%';
      let data;
      try{ data=await r.json(); }catch{ res.textContent='Error'; bar.style.width='0%'; sum.textContent='Idle'; return; }
      bar.style.width='90%';
      lastTrades = data.trades || [];
      const s = data.summary, R = data.results;
      let signalText = s.group === 'User Defined Confluence' ? s.signal : ({
        ichimoku:'Ichimoku', ema_pullback:'EMA(9/21) Pullback', bbsqueeze:'Bollinger Squeeze Breakout', donchian:'Donchian 20 Break', orb_london:'Opening-Range Breakout (London)', rsi2:'RSI-2 Mean Reversion', astra1:'AstraFX #1'
      }[s.signal] || s.signal);
      const resultsText =
`RESULTS

Group: ${s.group === 'AstraFX Proprietary' ? 'AstraFX Proprietary Strategies' : s.group.toUpperCase()}
Signal: ${signalText}
Timeframe: ${s.timeframe}
Exit Rule: ${s.exit_rule}
Min Score: ${s.min_score}
Look back: ${s.lookback_days} days

Pair: ${R.pair}
Trades: ${R.trades}
Wins: ${R.wins}
Losses: ${R.losses}
Win%: ${R.win_pct}%`;
      res.textContent = resultsText;
      csvBtn.disabled = lastTrades.length===0;
      bar.style.width='100%'; setTimeout(()=>{bar.style.width='0%';}, 800);
      sum.textContent='Done';
    });

    csvBtn.addEventListener('click', ()=>{
      const rows=[['time','direction','entry','stop','tp','outcome','bars_held']];
      for(const t of lastTrades){ rows.push([t.time,t.direction,t.entry,t.stop,t.tp,t.outcome,t.bars_held]); }
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='strategy_tester_results.csv'; a.click(); URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
