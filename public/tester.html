
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AstraFX â€” Strategy Tester</title>
  <!-- Uses existing global styles; page-local tweaks below -->
  <style>
    /* --- Cosmetic-only overrides (no JS behavior changes) --- */
    :root {
      --glass-bg: rgba(255,255,255,0.06);
      --glass-stroke: rgba(255,255,255,0.12);
      --text: #eaeef6;
      --text-dim: #9fb2d1;
      --brand: #5aa2ff;
    }
    body {
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text);
      background: #0a0f1a;
      background-size:cover;
      background-attachment:fixed;
    }

    /* Header/Hero copied structure (matches scanner hero semantics) */
    .hero {
      position: relative;
      padding: 24px 28px 20px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid var(--glass-stroke);
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.05));
      backdrop-filter: blur(8px);
    }
    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .brand .logo {
      width:28px;height:28px;border-radius:6px;
      background: var(--glass-bg);
      border:1px solid var(--glass-stroke);
    }
    .brand .title {
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .brand h1 {
      margin:0;
      font-size: 22px;
      font-weight: 700;
      letter-spacing:.2px;
      color:#fff;
    }
    .brand .kicker {
      margin-top:4px;
      font-size: 13px;
      color: var(--brand);
      opacity: .95;
      font-weight: 600;
    }

    /* Right nav buttons (far right, transparent like other pages) */
    .nav-actions {
      display:flex;
      gap:10px;
      margin-left:auto;
    }
    .btn-ghost {
      appearance:none;
      border:1px solid var(--glass-stroke);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      padding:10px 14px;
      font-size:13px;
      border-radius:10px;
      cursor:pointer;
      transition: all .15s ease-in-out;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn-ghost:hover{ background: rgba(255,255,255,0.06);}
    .btn-primary {
      border-color: rgba(90,162,255,0.35);
      box-shadow: inset 0 0 0 1px rgba(90,162,255,0.25);
    }

    /* Page layout */
    .wrap { padding: 18px 28px 48px; }
    .card {
      border:1px solid var(--glass-stroke);
      background: rgba(9,16,29,0.6);
      border-radius:14px;
      padding:16px;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap:12px;
    }
    .grid.row2 { margin-top:10px; }

    .field {
      display:flex; flex-direction:column; gap:8px;
    }
    .label {
      font-size:12px; color:var(--text-dim); letter-spacing:.2px;
    }

    /* Make native selects look like the rest & be readable on dark bg */
    .select, select, input[type="range"] {
      width:100%;
      border-radius:10px;
      border:1px solid var(--glass-stroke);
      background: rgba(255,255,255,0.02); /* transparent feel */
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    select option { color: #0a0f1a; } /* dropdown list stays readable */
    .range-wrap { padding:8px 10px; border-radius:10px; border:1px solid var(--glass-stroke); background: rgba(255,255,255,0.02); }
    .range-meta { display:flex; justify-content:space-between; font-size:12px; color:var(--text-dim); margin-top:6px; }

    /* Custom multi-select dropdown for UDC (checkbox list in popover) */
    .udc-wrap { position:relative; }
    .udc-toggle {
      width:100%;
      border-radius:10px; border:1px solid var(--glass-stroke);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      padding:10px 12px;
      text-align:left;
      cursor:pointer;
    }
    .udc-menu {
      position:absolute; z-index:30;
      top: calc(100% + 8px); left:0; right:0;
      max-height: 280px; overflow:auto;
      border:1px solid var(--glass-stroke);
      background: rgba(10,16,26,0.98);
      backdrop-filter: blur(6px);
      border-radius:12px;
      padding:8px;
      display:none;
    }
    .udc-menu.open { display:block; }
    .udc-item {
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:8px; cursor:pointer;
    }
    .udc-item:hover { background: rgba(255,255,255,0.04); }
    .udc-item input { margin:0; }

    /* Status */
    .status {
      margin-top:14px;
      display:flex; align-items:center; gap:12px;
      font-size:13px; color:var(--text-dim);
    }
    .bar {
      height:6px; flex:1;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .bar > span {
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, #4aa3ff, #7ee0ff);
      transition: width .25s ease;
    }

    /* Results block */
    .results { margin-top:18px; }
    .results h3 { margin:0 0 10px 0; font-size:16px; letter-spacing:.3px; }
    .results pre {
      margin:0; padding:16px; border-radius:12px;
      background: rgba(255,255,255,0.02);
      border:1px solid var(--glass-stroke);
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      color: var(--text);
    }

    /* Right-side actions */
    .aside {
      display:flex; flex-direction:column; gap:10px;
      position:fixed; right:20px; top:180px;
    }
    .aside .btn-ghost { padding:12px 14px; }

    @media (max-width:1100px){
      .grid { grid-template-columns: repeat(2, minmax(160px,1fr)); }
      .aside { position:static; margin-top:14px; }
    }
  </style>
</head>
<body>

  <!-- HERO (identical style/placement; only text changed) -->
  <header class="hero">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Strategy Tester</h1>
        <span class="kicker">(Up to the last 30 days)</span>
      </div>
    </div>
    <nav class="nav-actions">
      <a class="btn-ghost" href="/index.html">Scanner</a>
      <a class="btn-ghost" href="/public/journal.html">Trade Journal</a>
      <a class="btn-ghost btn-primary" href="/tester.html">Strategy Tester</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <!-- Row 1 -->
      <div class="grid">
        <div class="field">
          <span class="label">Pairs</span>
          <select id="pair">
            <option>XAUUSD</option>
            <option>EURUSD</option>
            <option>GBPUSD</option>
            <option>USDJPY</option>
            <option>USDCAD</option>
            <option>NZDUSD</option>
            <option>AUDUSD</option>
            <option>EURJPY</option>
            <option>GBPJPY</option>
          </select>
        </div>

        <div class="field">
          <span class="label">Timeframe</span>
          <select id="tf">
            <option>M5</option><option selected>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option>
          </select>
        </div>

        <div class="field">
          <span class="label">Lookback</span>
          <select id="lookback">
            <option>3 days</option><option>7 days</option><option>14 days</option><option selected>30 days</option>
          </select>
        </div>

        <div class="field">
          <span class="label">Min Score</span>
          <div class="range-wrap">
            <input id="minScore" type="range" min="0" max="100" value="70"/>
            <div class="range-meta"><span>0</span><span id="minScoreVal">70</span><span>100</span></div>
          </div>
        </div>

        <div class="field">
          <span class="label">Exit Rule</span>
          <select id="exitRule">
            <option>TP1</option><option>TP2</option><option>TP3</option>
          </select>
        </div>
      </div>

      <!-- Row 2 (mutually exclusive) -->
      <div class="grid row2">
        <div class="field">
          <span class="label">Strategy</span>
          <select id="strategy">
            <option>- Select -</option>
            <option>Ichimoku</option>
            <option>EMA 9/21 Pullback</option>
            <option>Bollinger Squeeze Breakout</option>
            <option>Donchian 20 Break</option>
            <option>London ORB</option>
            <option>RSI-2 Mean Reversion</option>
          </select>
        </div>

        <div class="field">
          <span class="label">Pattern</span>
          <select id="pattern">
            <option>- Select -</option>
            <option>Pin Bar</option>
            <option>Engulfing</option>
            <option>Inside Bar</option>
            <option>NR7</option>
          </select>
        </div>

        <div class="field">
          <span class="label">AstraFX Proprietary Strategies</span>
          <select id="prop">
            <option>- Select -</option>
            <option>AstraFX #1</option>
          </select>
        </div>

        <div class="field udc-wrap">
          <span class="label">User Defined Confluence</span>
          <button id="udcBtn" class="udc-toggle" type="button">- Select -</button>
          <div id="udcMenu" class="udc-menu" aria-hidden="true">
            <!-- 19 checkbox items -->
            <label class="udc-item"><input type="checkbox" value="Trend & Structure"><span>Trend & Structure</span></label>
            <label class="udc-item"><input type="checkbox" value="D1/H4 bias"><span>D1/H4 bias</span></label>
            <label class="udc-item"><input type="checkbox" value="20/50 EMA slope"><span>20/50 EMA slope</span></label>
            <label class="udc-item"><input type="checkbox" value="20/50 EMA stack"><span>20/50 EMA stack</span></label>
            <label class="udc-item"><input type="checkbox" value="Location"><span>Location</span></label>
            <label class="udc-item"><input type="checkbox" value="HTF S/R"><span>HTF S/R</span></label>
            <label class="udc-item"><input type="checkbox" value="Supplyâ€“Demand zones"><span>Supplyâ€“Demand zones</span></label>
            <label class="udc-item"><input type="checkbox" value="FIB overlap"><span>FIB overlap</span></label>
            <label class="udc-item"><input type="checkbox" value="Round levels"><span>Round levels</span></label>
            <label class="udc-item"><input type="checkbox" value="Prior day H/L"><span>Prior day H/L</span></label>
            <label class="udc-item"><input type="checkbox" value="Classic pivots"><span>Classic pivots</span></label>
            <label class="udc-item"><input type="checkbox" value="Liquidity & Imbalance"><span>Liquidity & Imbalance</span></label>
            <label class="udc-item"><input type="checkbox" value="Liquidity sweep"><span>Liquidity sweep</span></label>
            <label class="udc-item"><input type="checkbox" value="Fair Value Gap"><span>Fair Value Gap</span></label>
            <label class="udc-item"><input type="checkbox" value="Momentum Confirmation"><span>Momentum Confirmation</span></label>
            <label class="udc-item"><input type="checkbox" value="Pinbar"><span>Pinbar</span></label>
            <label class="udc-item"><input type="checkbox" value="Engulfing"><span>Engulfing</span></label>
            <label class="udc-item"><input type="checkbox" value="Morning/Evening star"><span>Morning/Evening star</span></label>
            <label class="udc-item"><input type="checkbox" value="Hanging man"><span>Hanging man</span></label>
          </div>
          <!-- Hidden input to preserve previous JS contract: comma-separated udc -->
          <input id="udc" type="hidden" value=""/>
        </div>
      </div>

      <!-- Summary / Status -->
      <div class="status">
        <span>Status: <strong id="statusLabel">Idle</strong></span>
        <div class="bar"><span id="barFill"></span></div>
      </div>

      <!-- Results -->
      <div class="results">
        <h3>RESULTS</h3>
        <pre id="resultsPre">Run a test to see results here.</pre>
      </div>
    </section>

    <!-- Right-side actions -->
    <aside class="aside">
      <button id="runBtn" class="btn-ghost btn-primary" type="button">Run Test</button>
      <button id="csvBtn" class="btn-ghost" type="button">Download CSV</button>
    </aside>
  </main>

  <script>
    // Preserve existing behavior expectations (IDs and requests)
    const minRange = document.getElementById('minScore');
    const minVal = document.getElementById('minScoreVal');
    minRange.addEventListener('input', () => minVal.textContent = minRange.value);

    const s = document.getElementById('strategy');
    const p = document.getElementById('pattern');
    const pr= document.getElementById('prop');
    const udcHidden = document.getElementById('udc');

    function setDisabledExcept(except) {
      const controls = [s, p, pr];
      controls.forEach(el => {
        if (except && el !== except) {
          el.disabled = true; el.style.opacity = .55;
        } else {
          el.disabled = false; el.style.opacity = 1;
        }
      });
      const udcBtn = document.getElementById('udcBtn');
      if (except) { udcBtn.disabled = true; udcBtn.style.opacity = .55; }
      else { udcBtn.disabled = false; udcBtn.style.opacity = 1; }
    }
    function onRow2Changed(e){
      const hasSel = (el)=> el && el.value && el.value !== '- Select -';
      const selected = [s,p,pr].find(hasSel);
      setDisabledExcept(selected || null);
      if (selected) { udcHidden.value = ''; updateUdcLabel(); }
    }
    [s,p,pr].forEach(el => el.addEventListener('change', onRow2Changed));

    // UDC multi-select popover
    const udcBtn = document.getElementById('udcBtn');
    const udcMenu = document.getElementById('udcMenu');
    function updateUdcLabel(){
      const vals = Array.from(udcMenu.querySelectorAll('input:checked')).map(i=>i.value);
      udcHidden.value = vals.join(',');
      udcBtn.textContent = vals.length ? vals.join(', ') : '- Select -';
    }
    udcBtn.addEventListener('click', () => {
      if (udcBtn.disabled) return;
      udcMenu.classList.toggle('open');
    });
    udcMenu.addEventListener('change', updateUdcLabel);
    document.addEventListener('click', (e)=>{
      if (!udcMenu.contains(e.target) && !udcBtn.contains(e.target)) {
        udcMenu.classList.remove('open');
      }
    });
    udcMenu.addEventListener('change', ()=>{
      const any = udcHidden.value.length>0;
      [s,p,pr].forEach(el=>{
        el.disabled = any; el.style.opacity = any?.55:1;
        if (any) el.value='- Select -';
      });
    });

    const statusLabel = document.getElementById('statusLabel');
    const barFill = document.getElementById('barFill');
    function setStatus(state){
      statusLabel.textContent = state;
      if (state==='Runningâ€¦') barFill.style.width = '65%';
      if (state==='Done') barFill.style.width = '100%';
      if (state==='Idle') barFill.style.width = '0%';
    }

    async function runTest(){
      const pair = document.getElementById('pair').value;
      const tf = document.getElementById('tf').value;
      const lbTxt = document.getElementById('lookback').value;
      const lookback_days = parseInt(lbTxt);
      const min_score = parseInt(minRange.value, 10);
      const exit_rule = document.getElementById('exitRule').value;

      let group = '';
      let signal = '';
      if (s.value && s.value !== '- Select -') { group='strategy'; signal=s.value; }
      else if (p.value && p.value !== '- Select -') { group='pattern'; signal=p.value; }
      else if (pr.value && pr.value !== '- Select -') { group='prop'; signal=pr.value; }
      else if (udcHidden.value) { group='udc'; }

      if (!group){
        alert('Pick one: Strategy, Pattern, Proprietary, or User-Defined Confluence.');
        return;
      }

      setStatus('Runningâ€¦');
      const qs = new URLSearchParams({
        pair, tf, lookback_days, min_score, exit_rule, group, signal, udc: udcHidden.value
      }).toString();
      const res = await fetch(`/api/tester?${qs}`);
      const data = await res.json();

      setStatus('Done');
      const r = data?.results || {};
      const g = data?.summary?.group || (group==='udc'?'User Defined Confluence':group.toUpperCase());
      const sig = data?.summary?.signal || (group==='udc' ? (udcHidden.value.split(',').join(', ')) : signal);

      const text =
`RESULTS

Group: ${g}
Signal: ${sig || '-'}
Timeframe: ${tf}
Exit Rule: ${exit_rule}
Min Score: ${min_score}
Look back: ${lookback_days} days

Pair: ${r.pair || pair}
Trades: ${r.trades ?? 0}
Wins: ${r.wins ?? 0}
Losses: ${r.losses ?? 0}
Win%: ${(r.win_pct ?? 0).toFixed(1)}%`;
      document.getElementById('resultsPre').textContent = text;
      window.__lastTradesForCsv = data?.trades || [];
    }

    async function downloadCsv(){
      const rows = window.__lastTradesForCsv||[];
      if (!rows.length){ alert('Run a test first.'); return; }
      const headers = Object.keys(rows[0]);
      const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>JSON.stringify(r[h]??'')).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'strategy_tester_results.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('runBtn').addEventListener('click', runTest);
    document.getElementById('csvBtn').addEventListener('click', downloadCsv);
  </script>
</body>
</html>
